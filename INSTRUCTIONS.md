# Инструкция по доработке s-ui

## Текущее состояние проекта

Проект `s-ui` был доработан для поддержки управления через Telegram-бота. Были реализованы и исправлены следующие команды:

-   `/adduser <email> <traffic_gb> [inbound_tag]`: Добавляет нового пользователя. Можно указать тег входящего интерфейса.
-   `/deluser <email>`: Удаляет пользователя.
-   `/stats`: Показывает онлайн-статистику.
-   `/logs`: Показывает логи.
-   `/restart`: Перезапускает сервис s-ui.
-   `/sublink <email>`: Генерирует ссылки на подписку для пользователя.
-   `/add_in <type> <tag> <port>`: Создает новый входящий интерфейс.
-   `/add_out <json>`: Создает новый исходящий интерфейс (требует полного JSON).
-   `/help_devel`: Показывает подробную информацию для разработчика.

## Последние изменения

1.  **Упрощена команда `/add_in`**: Теперь она принимает тип, тег и порт, а не полный JSON.
2.  **Улучшена команда `/adduser`**: Добавлена возможность указывать тег входящего интерфейса.
3.  **Исправлена ошибка `unexpected end of JSON input`**: Проблема была в неинициализированном поле `Links` при создании нового клиента.
4.  **Исправлена ошибка `converting NULL to string is unsupported`**: Проблема была в обработке `NULL` значений из базы данных при поиске пользователей.

## Дальнейшие шаги

-   Можно упростить команду `/add_out`, аналогично `/add_in`.
-   Можно добавить больше типов входящих интерфейсов в упрощенную команду `/add_in`.
-   Можно добавить больше настроек в команду `/adduser`.

## Детали исправления ошибок

### 1. Ошибка `unexpected end of JSON input` при добавлении пользователя

-   **Проблема:** При выполнении команды `/adduser` возникала ошибка `unexpected end of JSON input` в функции `updateLinksWithFixedInbounds` (`service/client.go`).
-   **Причина:** При создании нового клиента (`model.Client`) в функции `handleAddUser` (`telegram/bot.go`), поле `Links` не инициализировалось. Из-за тега `omitempty` в модели, это поле отсутствовало в итоговом JSON. В функции `updateLinksWithFixedInbounds` происходила попытка разбора этого поля, которое было `nil`, что и приводило к ошибке.
-   **Решение:** В `handleAddUser` поле `Links` теперь инициализируется пустым JSON-массивом `json.RawMessage("[]")`.

### 2. Ошибка `converting NULL to string is unsupported` при добавлении пользователя

-   **Проблема:** После исправления первой ошибки, при выполнении `/adduser` стала появляться ошибка `converting NULL to string is unsupported` в функции `fetchUsers` (`service/inbounds.go`).
-   **Причина:** SQL-запрос `SELECT json_extract(clients.config, "$.<inboundType>")` возвращал `NULL`, если у клиента в поле `config` не было ключа для данного типа входящего подключения. Драйвер базы данных не мог преобразовать `NULL` в строку.
-   **Решение:** SQL-запрос был изменен для использования функции `COALESCE`. Теперь он выглядит так: `SELECT COALESCE(json_extract(clients.config, "$.%s"), '')`. Это заменяет `NULL` на пустую строку, что позволяет избежать ошибки при сканировании результатов.

### 3. Ошибка `Conflict: terminated by other getUpdates request` при перезапуске

-   **Проблема:** Команда `/restart` приводила к конфликту, так как старый экземпляр бота не останавливался перед запуском нового.
-   **Причина:** Функция `RestartApp` в `app/app.go` пыталась выполнить "горячий" перезапуск внутри одного процесса, что не завершало работу старого экземпляра Telegram-бота.
-   **Решение:** Логика `RestartApp` была изменена. Теперь она вызывает `os.Exit(0)`, полностью завершая работу приложения. Это позволяет внешней системе управления службами (например, `systemd`) корректно перезапустить процесс, гарантируя, что в каждый момент времени работает только один экземпляр бота.

## Связь бота с основным функционалом

Telegram-бот интегрирован в основное приложение `s-ui` через интерфейс `AppServices` (`telegram/bot.go`).

-   **Инициализация:** Бот запускается в `app/app.go` как горутина. Конфигурация читается из файла `telegram_config.json`.
-   **Интерфейс `AppServices`:** Этот интерфейс определяет "контракт" между ботом и основным приложением. Он предоставляет боту доступ к необходимым сервисам (`ConfigService`, `StatsService` и т.д.) без прямого доступа ко всей структуре приложения.
-   **Выполнение команд:** Когда бот получает команду (например, `/adduser`), он вызывает соответствующий метод интерфейса `AppServices` (например, `a.configService.Save(...)`). Основное приложение выполняет действие и возвращает результат.

## Сборка и запуск

### Детали сборки

Скрипт `build.sh` выполняет два основных шага:
1.  **Сборка фронтенда:**
    -   Переходит в директорию `frontend`.
    -   Устанавливает зависимости с помощью `npm i`.
    -   Собирает статичные файлы веб-интерфейса с помощью `npm run build`.
    -   Копирует собранные файлы в `web/html/`.
2.  **Сборка бэкенда:**
    -   Собирает Go-приложение с помощью `go build`.
    -   Флаги `-ldflags "-w -s"` используются для уменьшения размера итогового бинарного файла.
    -   Флаги `-tags "..."` включают в сборку различные функции (например, `with_quic`, `with_grpc`).
    -   Итоговый исполняемый файл `sui` создается в корневой директории проекта.

### Запуск

-   **Для разработки:** Используйте скрипт `runSUI.sh`. Он устанавливает переменные окружения и запускает исполняемый файл `sui`.
-   **Для продакшена:** Рекомендуется запускать `s-ui` как сервис `systemd`.
    1.  Создайте файл `/etc/systemd/system/s-ui.service` с содержимым, адаптированным под ваше окружение (пути `WorkingDirectory` и `ExecStart`).
    2.  Выполните `sudo systemctl daemon-reload`.
    3.  Включите и запустите сервис: `sudo systemctl enable --now s-ui.service`.
    4.  Это обеспечит автоматический перезапуск приложения после сбоев или после выполнения команды `/restart` из Telegram-бота.

## Анализ безопасности

Был проведен анализ безопасности логов запуска приложения.

### Контроль маршрутов API

-   **Маршруты \`/api\`:** Защищены аутентификацией на основе сессий. Middleware в \`api/apiHandler.go\` вызывает \`checkLogin(c)\` для всех запросов, кроме \`login\` и \`logout\`.
-   **Маршруты \`/apiv2\`:** Защищены аутентификацией на основе токенов. Middleware в \`api/apiV2Handler.go\` вызывает \`checkToken(c)\`, который проверяет заголовок \`Token\`.

### Потенциальные риски

-   **Секрет для сессий:** Безопасность сессий зависит от секретного ключа. Рекомендуется использовать длинный, криптографически случайный ключ.
-   **Защита статичных файлов:** Существует теоретический риск атаки "Path Traversal", но он минимизирован благодаря использованию \`engine.StaticFS\` в Gin.
-   **Токены аутентификации:** Безопасность токенов зависит от их стойкости, безопасной передачи (HTTPS) и срока действия. Рекомендуется избегать неистекающих токенов.
-   **Авторизация:** Необходимо убедиться, что в дополнение к аутентификации, в функциях \`ApiService\` реализована проверка прав доступа для выполнения критических действий.
-   **Валидация ввода:** Всегда существует риск инъекций, если входные данные от пользователя не валидируются должным образом.
-   **Ограничение скорости запросов (Rate Limiting):** Эндпоинты должны быть защищены от DoS-атак.
